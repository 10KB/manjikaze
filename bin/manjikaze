#!/bin/bash
set -e

MANJIKAZE_DIR="$HOME/.manjikaze"
source "$MANJIKAZE_DIR/lib/common.sh"
source "$MANJIKAZE_DIR/lib/state.sh"
source "$MANJIKAZE_DIR/lib/migrations.sh"
source "$MANJIKAZE_DIR/lib/menus.sh"

check_updates() {
    if [ -d "$MANJIKAZE_DIR/.git" ]; then
        status "Checking for Manjikaze updates..."
        git -C "$MANJIKAZE_DIR" fetch origin >/dev/null 2>&1
        local_rev=$(git -C "$MANJIKAZE_DIR" rev-parse HEAD)
        remote_rev=$(git -C "$MANJIKAZE_DIR" rev-parse @{u})
        if [ "$local_rev" != "$remote_rev" ]; then
            if gum confirm "Updates available. Would you like to update Manjikaze?"; then
                git -C "$MANJIKAZE_DIR" pull
                exec "$0" "$@"  # Restart the script with the same arguments
            fi
        fi
    fi
}

check_prerequisites() {
    status "Checking system prerequisites..."
    local prerequisites=(archlinux-keyring base-devel git gum jq yay)
    local to_install=()

    for pkg in "${prerequisites[@]}"; do
        if ! is_installed "$pkg"; then
            to_install+=("$pkg")
        fi
    done

    if [ ${#to_install[@]} -ne 0 ]; then
        status "Installing prerequisites: ${to_install[*]}..."
        sudo pacman -Sy "${to_install[@]}" --noconfirm --noprogressbar --quiet
    fi
}

show_header() {
    gum style \
        --border double \
        --align center \
        --width 50 \
        --margin "1 2" \
        --padding "1 2" \
        "Manjikaze $(get_version)" \
        "10KB Development Environment"
}

main() {
    clear
    show_header

    status "Requesting administrator privileges for system commands..."
    sudo -v
    (while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &)

    check_updates "$@"

    check_prerequisites

    run_migrations || status "Migration check/run finished with errors or cancellation."

    clear
    show_header

    handle_menu menu "Main Menu"
}

main "$@"
